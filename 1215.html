<html>
    <head>
        <title>1215-宇宙射擊遊戲</title>
        <style>
            #spaces{
                width:800px;
                height:800px;
                background:url("pic/bg_stars.jpg");
                animation:bg_move 1s linear infinite;
            }
            @keyframes bg_move{
                0%{background-position-y: 0px;}
                100%{background-position-y:216px;}
            }
            #ship{
                width:40px;
                height:60px;
                background:url("pic/ship.png");
                background-size:40px 60px;
                position:absolute;
                top: 740px;
                left: 380px;
            }
            .ufo{
                width:60px;
                height: 40px;
                background:url("pic/ufo.png");
                background-size:60px 40px;
                position:absolute;
            }
            .bullet{
                width:6px;
                height:4px;
                background-color: red;
                position:absolute;
            }
            #status{
                width: 800px;
            }
        </style>
        <script>
            function game_init(){
                dir={"ArrowLeft":0,"ArrowRight":0,"ArrowUp":0,"Arrowdown":0}
                spaces={w:800,h:800};//自定義一個物件
                ship=document.getElementById("ship");
                ship.w=40;
                ship.h=60;
                ship.posX=(spaces.w-ship.w)/2;
                ship.posY=spaces.h-ship.h;
                ship.style.left=ship.posX+"px";
                ship.style.top=ship.posY+"px";
                ship.move=setInterval(ship_move,5);
                game_score=0;
                game_time=0;
                game_timer=setInterval(function(){
                    game_time++;
                    document.getElementById("game_time").innerHTML
                },1000);
                Array.from(document.getElementsByClassName("ufo")).forEach((u)=>{
                    u.remove();
                });
                game_t1=setInterval(ufo_create,1000);
                game_starting=true;
            }
            function game_over(){
                game_starting=false;
                clearInterval(ship_move);
                clearInterval(ufo_creater);
                clearInterval(game_timer);
                document.getElementById("spaces").style.animationPlayState="paused";
                Array.from(document.getElementsByClassName("ufo")).forEach((u)=>{
                    clearInterval(u.move);
                });
                Array.from(document.getElementsByClassName("bullet")).forEach((b)=>{
                    clearInterval(b.move);
                });
                document.getElementById("restart").style.display="block";
                if(sessionStorage.getItem("ranking")){
                    data=[];
                    data.push({"name":prompt("請輸入你的名稱:"),"score":game_score,"time":game_time});
                    sessionStorage.setItem("ranking",JSON.stringify(ranking));
                }else{
                    var data=JSON.parse(ranking);
                    if(data.length<5){
                        data.push({"name":prompt("請輸入你的名稱:"),"score":game_score,"time":game_time});   
                    }else if(game_score>data[4].score){
                        data.pop();
                    }
                    data.sort((a,b)=>{
                        return b.score-a.score;
                    });
                    sessionStorage.setItem("ranking",JSON.stringify(data));
                }
                
            }
            function mykeyup(){
                event.preventDefault();
                if(Object.keys(dir).includes(event.key)){}
                dir[event.key]=0;
            
            }
            function mykeydown(){
                
                event.preventDefault();
                if(event.key== " "){
                    shoot();
                }else if(Object.keys(dir).includes(event.key)){
                    dir[event.key]=1;
                }
            }
            function ship_move(){
                if(ship.posX>0 && dir["ArrowLeft"]){
                    ship,posX--;
                }else if (ship.posX+ship.w<spaces.w && dir["ArrowRight"]){
                    ship.posX++;
                }
                ship.style.left=ship.posX+"px";
            }
            function getRand(min,max){
                return Math.floor(Math.random()*(max-min+1)) +min;
            }
            function ufo_move(ufo){
                if(ufo.posY+ufo.h>spaces.h){
                    clearInterval(ufo.move);
                    ufo.remove();
                    game_over();
                    return;
                }
                ufo.posY++;
                ufo.posX+=getRand(-2,2);
                if(ufo.posX<0){
                    ufo.posX=0;
                }else if(ufo.posX+ufo.w>spaces.w){
                    ufo.posX=spaces.w-ufo.w;
                }
                    ufo.style.left=ufo.posX+"px";
                    ufo.style.top=ufo.posY+"px";
            }

            
            function ufo_create(){
                var u=document.createElement("img")
                u.src="pic/ufo.png";
                u.className="ufo";
                u.w=60;
                u.h=40;
                u.posX=gtRand(0,spaces.w-u.w);
                u.posY=getRand(0,10);
                document.getElementById("spaces").appendChild(u);
                u.style.left=u.posX+"px";
                u.style.top=u.posY+"px";
                u.move=setInterval(ufo_move,20,u);

            }
            function bullet_move(bt){
                if(bt.posY<0){
                    clearInterval(bt.move);
                    bt.remove();
                    return;
                }    
                bt.posY--;
                bt.style.top=bt.posY+"px";

               var hit_ufo=Array.from(document.getElementsByClassName("ufo")).filter((u)=>{
                    return(u.posX<bt.posX)&&(u.posX+u.w>bt.posX+bt.w);
                    (u.posY+u.h>=bt.posY);
                });
                if(hit_ufo.length>0){
                    hit_ufo.forEach((u)=>{
                        clearInterval(u.move);
                        u.remove();
                    });
                    clearInterval(bt.move);
                    bt.remove();
                    game_score++;
                    document.getElementById("score").innerHTML=game_score;
                    return;
                }
            }
            function shoot(){
                if(game_starting==false) return;
                var b=document.createElement("div")
                b.className="bullet";
                b.w=6;
                b.h=4;
                ship.posX=(spaces.w-ship.w)/2;
                ship.posY=spaces.h-ship.h;
                document.getElementById("spaces").appendChild(b);
                b.style.left=u.posX+"px";
                b.style.top=u.posY+"px";
                b.move=setInterval(bullet_move,10,b);
            }
            function show_ranking(){
                var ranking=sessionStorage.getItem("ranking");
                if(ranking){
                var data=Array.from(JSON.parse(ranking));
                }
                
                if(ranking==null){
                    ranking=[];
                    ranking.push({"name":pronpt("請輸入自己的名稱:"),"score":game_score,"time":game_timer})
                }
            }
            function do_ranking(){

            }

        </script>
    </head>
    <body onload="game_init()" onkeydown="mykeydown()" onkeyup="mykeyup()">
        <div id="status">
            <span>得分:<span id="score">0</span>分</span>  
            <span style="float: right;">時間:<span id="game_time">0</span>秒</span> 
            <div>
        <div id="spaces">
            <div id="ship"></div>
            <!--img src="pic/ship.png" width="40px"-->
        </div>
        <button id="restart" onclick="game_init"></button>

    </body>
</html>